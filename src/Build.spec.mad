import { test, assertEquals, AssertionError, Error } from "TestTools"
import { exec, CommandError } from "System"
import { bad, chainRej, mapRej, Wish } from "Wish"
import { andDo } from "Monad"
import IO from "IO"

import type { IOUtils } from "@/IOUtils"
import type { Config } from "@/Build"
import {
  pathToDocument,
  madDocRootPath,
  sassExecutablePath,
  madDocSrcPath,
  documentationTargetPath,
  madDocMainPath,
  sassPath,
  htmlSourcePath,
  generateConfiguration,
  generateJson,
  buildBundle,
  buildSass,
  copyHtml,
  buildDocumentation
} from "@/Build"

INITIAL_IOUTILS :: IOUtils
INITIAL_IOUTILS = {
  getArgs: of([]),
  getCurrentPath: of(""),
  getExecutablePath: of(""),
  exec: (x) => of(x)
}

DEFAULT_CONFIG :: Config
DEFAULT_CONFIG = {
  madlib: {
    input: "/home/madlib/maddoc-cli/madlib_modules/MadDoc/src/Main.mad",
    output: ".docs/bundle.js"
  },
  styles: {
    input: "/home/madlib/maddoc-cli/madlib_modules/MadDoc/src/styles/main.scss",
    output: ".docs/styles/main.css"
  },
  html: {
    input: "/home/madlib/maddoc-cli/madlib_modules/MadDoc/src/index.html",
    output: ".docs/index.html"
  },
  sassExecutablePath: "/home/madlib/maddoc-cli/node_modules/.bin/sass",
  documentationDotJson: {
    input: "/path/to/document",
    output: "/home/madlib/maddoc-cli/madlib_modules/MadDoc/src/documentation.json"
  }
}

test("pathToDocument - arg is set", (_) => pipe(
  pathToDocument,
  mapRej((_) => Error("pathToDocument should succeed")),
  chain(assertEquals($, "/path/to/document"))
)({ ...INITIAL_IOUTILS, getArgs: of(["/path/to/document"]) }))

test("pathToDocument - arg is not set", (_) => pipe(
  pathToDocument,
  chainRej(assertEquals($, "You must give a path to the .mad files to document!"))
)({ ...INITIAL_IOUTILS, getArgs: of([]) }))

test("madDocRootPath - should return the root of maddoc project", (_) => pipe(
  madDocRootPath,
  mapRej((_) => Error("madDocRootPath should be success")),
  chain(assertEquals($, "/home/madlib/maddoc-cli/madlib_modules/MadDoc"))
)({ ...INITIAL_IOUTILS, getExecutablePath: of("/home/madlib/maddoc-cli/.run/Main.mjs") }))

test("madDocRootPath - should return the root of maddoc project when installed as a dependency", (_) => pipe(
  madDocRootPath,
  mapRej((_) => Error("madDocRootPath should be success")),
  chain(assertEquals($, "/home/madlib/my-package/madlib_modules/MadDoc"))
)({ ...INITIAL_IOUTILS, getExecutablePath: of("/home/madlib/my-package/madlib_modules/https___github_com_madlib_lang_maddoc_cli_archive_refs_heads_master_zip/.run/Main.mjs") }))

test("sassExecutablePath - should return the local sass install in node_modules if run locally", (_) => pipe(
  sassExecutablePath,
  mapRej((_) => Error("sassExecutablePath should be success")),
  chain(assertEquals($, "/home/madlib/maddoc-cli/node_modules/.bin/sass"))
)({ ...INITIAL_IOUTILS, getExecutablePath: of("/home/madlib/maddoc-cli/.run/Main.mjs") }))

test("sassExecutablePath - should return the local sass install in node_modules if run from a package", (_) => pipe(
  sassExecutablePath,
  mapRej((_) => Error("sassExecutablePath should be success")),
  chain(assertEquals($, "/home/madlib/my-package/node_modules/.bin/sass"))
)({
  ...INITIAL_IOUTILS,
  getExecutablePath: of(
    "/home/madlib/my-package/madlib_modules/MadDoc/.run/Main.mjs"
  )
}))

test("madDocSrcPath - should return the path of the src folder from MadDoc", (_) => pipe(
  madDocSrcPath,
  mapRej((_) => Error("madDocSrcPath should be success")),
  chain(assertEquals($, "/home/madlib/maddoc-cli/madlib_modules/MadDoc/src"))
)({ ...INITIAL_IOUTILS, getExecutablePath: of("/home/madlib/maddoc-cli/.run/Main.mjs") }))

test("documentationTargetPath - should return the path for the documentation.json file", (_) => pipe(
  documentationTargetPath,
  mapRej((_) => Error("documentationTargetPath should be success")),
  chain(assertEquals($, "/home/madlib/maddoc-cli/madlib_modules/MadDoc/src/documentation.json"))
)({ ...INITIAL_IOUTILS, getExecutablePath: of("/home/madlib/maddoc-cli/.run/Main.mjs") }))

test("madDocMainPath - should return the path for the Main module of MadDoc", (_) => pipe(
  madDocMainPath,
  mapRej((_) => Error("madDocMainPath should be success")),
  chain(assertEquals($, "/home/madlib/maddoc-cli/madlib_modules/MadDoc/src/Main.mad"))
)({ ...INITIAL_IOUTILS, getExecutablePath: of("/home/madlib/maddoc-cli/.run/Main.mjs") }))

test("sassPath - should return the path for the sass file to compile", (_) => pipe(
  sassPath,
  mapRej((_) => Error("sassPath should be success")),
  chain(assertEquals($, "/home/madlib/maddoc-cli/madlib_modules/MadDoc/src/styles/main.scss"))
)({ ...INITIAL_IOUTILS, getExecutablePath: of("/home/madlib/maddoc-cli/.run/Main.mjs") }))

test("htmlSourcePath - should return the path of index.html file to copy", (_) => pipe(
  htmlSourcePath,
  mapRej((_) => Error("htmlSourcePath should be success")),
  chain(assertEquals($, "/home/madlib/maddoc-cli/madlib_modules/MadDoc/src/index.html"))
)({ ...INITIAL_IOUTILS, getExecutablePath: of("/home/madlib/maddoc-cli/.run/Main.mjs") }))

test("generateConfiguration - should generate a correct Config with all paths", (_) => {
  expected = DEFAULT_CONFIG

  return pipe(
    generateConfiguration,
    mapRej((_) => Error(expected)),
    chain(assertEquals($, expected))
  )({
    ...INITIAL_IOUTILS,
    getExecutablePath: of("/home/madlib/maddoc-cli/.run/Main.mjs"),
    getArgs: of(["/path/to/document"])
  })
})

test("generateJson - should call 'madlib doc' command with correct options", (_) => {
  command = ""
  expected = "madlib doc -i /path/to/document > /home/madlib/maddoc-cli/madlib_modules/MadDoc/src/documentation.json"

  execRecorder = (cmd) => {
    command = cmd
    return of("good")
  }

  return pipe(
    generateJson({ ...INITIAL_IOUTILS, exec: execRecorder }),
    mapRej((_) => Error("generateJson should be success")),
    chain((_) => assertEquals(command, expected))
  )(DEFAULT_CONFIG)
})

test("generateJson - should reject if 'madlib doc' command fails", (_) => {
  expected = "An error occured while generating the docs, here is the error from madlib:\nCould not generate doc"
  execRecorder = (cmd) => bad(CommandError(1, "Could not generate doc"))

  return pipe(
    generateJson({ ...INITIAL_IOUTILS, exec: execRecorder }),
    chainRej(assertEquals($, expected))
  )(DEFAULT_CONFIG)
})

test("buildBundle - should call the madlib compiler with correct options", (_) => {
  command = ""
  expected = "madlib compile -i /home/madlib/maddoc-cli/madlib_modules/MadDoc/src/Main.mad --target browser --bundle -o .docs/bundle.js"

  execRecorder = (cmd) => {
    command = cmd
    return of("good")
  }

  return pipe(
    buildBundle({ ...INITIAL_IOUTILS, exec: execRecorder }),
    mapRej((_) => Error("buildBundle should be success")),
    chain((_) => assertEquals(command, expected))
  )(DEFAULT_CONFIG)
})

test("buildBundle - should reject if 'madlib compile' command fails", (_) => {
  expected = "Compilation error"
  execRecorder = (cmd) => bad(CommandError(1, "Compilation error"))

  return pipe(
    buildBundle({ ...INITIAL_IOUTILS, exec: execRecorder }),
    chainRej(assertEquals($, expected))
  )(DEFAULT_CONFIG)
})

test("buildSass - should call the sass executable with correct options", (_) => {
  command = ""
  expected = "/home/madlib/maddoc-cli/node_modules/.bin/sass /home/madlib/maddoc-cli/madlib_modules/MadDoc/src/styles/main.scss .docs/styles/main.css"

  execRecorder = (cmd) => {
    command = cmd
    return of("good")
  }

  return pipe(
    buildSass({ ...INITIAL_IOUTILS, exec: execRecorder }),
    mapRej((_) => Error("buildSass should be success")),
    chain((_) => assertEquals(command, expected))
  )(DEFAULT_CONFIG)
})

test("buildSass - should reject if 'sass' command fails", (_) => {
  expected = "Sass error"
  execRecorder = (cmd) => bad(CommandError(1, "Sass error"))

  return pipe(
    buildSass({ ...INITIAL_IOUTILS, exec: execRecorder }),
    chainRej(assertEquals($, expected))
  )(DEFAULT_CONFIG)
})

test("copyHtml - should call 'cp' with correct options", (_) => {
  command = ""
  expected = "cp /home/madlib/maddoc-cli/madlib_modules/MadDoc/src/index.html .docs/index.html"

  execRecorder = (cmd) => {
    command = cmd
    return of("good")
  }

  return pipe(
    copyHtml({ ...INITIAL_IOUTILS, exec: execRecorder }),
    mapRej((_) => Error("copyHtml should be success")),
    chain((_) => assertEquals(command, expected))
  )(DEFAULT_CONFIG)
})

test("copyHtml - should reject if 'cp' command fails", (_) => {
  expected = "cp error"
  execRecorder = (cmd) => bad(CommandError(1, "cp error"))

  return pipe(
    copyHtml({ ...INITIAL_IOUTILS, exec: execRecorder }),
    chainRej(assertEquals($, expected))
  )(DEFAULT_CONFIG)
})

test("buildDocumentation", (_) => {
  commands = []
  expected = [
    "madlib compile -i /home/madlib/maddoc-cli/madlib_modules/MadDoc/src/Main.mad --target browser --bundle -o .docs/bundle.js",
    "/home/madlib/maddoc-cli/node_modules/.bin/sass /home/madlib/maddoc-cli/madlib_modules/MadDoc/src/styles/main.scss .docs/styles/main.css",
    "cp /home/madlib/maddoc-cli/madlib_modules/MadDoc/src/index.html .docs/index.html"
  ]

  execRecorder = (cmd) => {
    commands = mappend(commands, [cmd])
    return of("good")
  }

  return pipe(
    buildDocumentation({ ...INITIAL_IOUTILS, exec: execRecorder }),
    mapRej((_) => Error(["buildDocumentation should be success"])),
    chain((_) => assertEquals(commands, expected))
  )(DEFAULT_CONFIG)
})
